# 基础功能完善任务清单

## 🎯 目标
完善 SuKaAI 的核心基础功能，确保系统稳定可靠，为后续高级功能打下坚实基础。

---

## 📦 Phase 1: 对话系统完善

### Task 1.1: 对话历史持久化 ⭐⭐⭐
**优先级**: 🔴 High  
**预计工时**: 4-6 小时

**功能描述**:
实现对话历史的数据库存储和加载功能，用户可以查看历史对话。

**技术实现**:
```sql
-- 需要添加的表结构
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    title VARCHAR(255), -- 自动生成或用户自定义
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE conversation_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
    role VARCHAR(20) CHECK (role IN ('user', 'assistant')),
    content TEXT NOT NULL,
    metadata JSONB DEFAULT '{}'::jsonb, -- 存储额外信息
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**任务清单**:
- [ ] 更新 `supabase/schema.sql` 添加对话相关表
- [ ] 创建 `/api/conversations` API 路由
  - [ ] POST - 创建新对话
  - [ ] GET - 获取对话列表（分页）
  - [ ] GET /:id - 获取单个对话
  - [ ] PUT /:id - 更新对话标题
  - [ ] DELETE /:id - 删除对话
- [ ] 创建 `/api/conversations/:id/messages` API 路由
  - [ ] POST - 保存消息
  - [ ] GET - 获取对话消息列表
- [ ] 更新 `MainLayout` 组件，自动保存对话
- [ ] 创建对话列表侧边栏组件
- [ ] 实现对话切换功能
- [ ] 添加对话搜索功能

**验收标准**:
- [ ] 对话自动保存到数据库
- [ ] 可以查看历史对话列表
- [ ] 可以切换不同对话
- [ ] 对话标题可以编辑
- [ ] 支持删除对话

---

### Task 1.2: 消息操作功能 ⭐⭐
**优先级**: 🟡 Medium  
**预计工时**: 2-3 小时

**功能描述**:
为消息添加操作菜单（复制、重新生成、编辑、删除、反馈）。

**任务清单**:
- [ ] 创建 `MessageActions` 组件
- [ ] 实现复制到剪贴板功能
- [ ] 实现消息重新生成（调用 API 重新生成）
- [ ] 实现消息编辑功能
- [ ] 实现消息删除功能
- [ ] 添加反馈按钮（👍/👎）
- [ ] 保存反馈到数据库（可选：创建 `message_feedback` 表）

**验收标准**:
- [ ] 右键或点击按钮可以打开操作菜单
- [ ] 所有操作功能正常工作
- [ ] 操作有视觉反馈

---

### Task 1.3: RAG 检索集成 ⭐⭐⭐
**优先级**: 🔴 High  
**预计工时**: 6-8 小时

**功能描述**:
在对话中集成 RAG 检索，从知识库中检索相关信息并注入到 LLM 上下文。

**技术实现**:
1. 用户输入查询
2. 生成查询向量
3. 使用 `match_intelligence` 函数搜索相似内容
4. 将检索结果注入到 LLM prompt
5. LLM 基于检索结果生成回答
6. 显示引用来源

**任务清单**:
- [ ] 创建 `/api/search/vector` API 路由
- [ ] 实现查询向量生成（使用 OpenAI embedding）
- [ ] 调用 Supabase `match_intelligence` 函数
- [ ] 更新 `/api/chat` 路由，集成 RAG
- [ ] 实现上下文注入逻辑
- [ ] 创建引用来源显示组件
- [ ] 在消息中显示引用链接
- [ ] 优化检索 prompt 和结果排序

**验收标准**:
- [ ] 对话可以检索相关知识库内容
- [ ] 回答中包含引用来源
- [ ] 可以点击引用查看原文
- [ ] 检索结果相关性高

---

## 📦 Phase 2: 用户系统完善

### Task 2.1: 用户设置页面 ⭐⭐
**优先级**: 🔴 High  
**预计工时**: 3-4 小时

**功能描述**:
创建用户设置页面，允许用户配置知识缺口分析阈值、平台提示词等。

**任务清单**:
- [ ] 创建 `/app/settings/page.tsx`
- [ ] 实现设置表单组件
- [ ] 创建 `/api/user/settings` API 路由
- [ ] 实现知识缺口阈值滑块（alpha, beta）
- [ ] 实现平台提示词编辑器
- [ ] 添加语言选择器
- [ ] 实现自动生成开关
- [ ] 添加设置保存和加载功能

**验收标准**:
- [ ] 可以访问设置页面
- [ ] 所有设置可以保存
- [ ] 设置立即生效
- [ ] 设置持久化到数据库

---

### Task 2.2: 用户资料管理 ⭐
**优先级**: 🟡 Medium  
**预计工时**: 2 小时

**功能描述**:
允许用户查看和编辑个人资料信息。

**任务清单**:
- [ ] 创建用户资料页面或模态框
- [ ] 显示用户信息（从 Google OAuth 获取）
- [ ] 实现头像上传功能（可选）
- [ ] 添加账户删除功能

---

## 📦 Phase 3: 错误处理和稳定性

### Task 3.1: 全局错误处理 ⭐⭐
**优先级**: 🔴 High  
**预计工时**: 3-4 小时

**功能描述**:
实现完善的错误处理机制，提供友好的错误提示。

**任务清单**:
- [ ] 创建 `ErrorBoundary` 组件
- [ ] 集成 Toast 通知系统（使用 `sonner` 或类似库）
- [ ] 实现 API 错误统一处理
- [ ] 添加网络错误检测和重试
- [ ] 实现错误日志记录（可选）

**验收标准**:
- [ ] 所有错误都有友好提示
- [ ] 网络错误可以重试
- [ ] 错误不会导致应用崩溃

---

### Task 3.2: 加载状态优化 ⭐
**优先级**: 🟡 Medium  
**预计工时**: 1-2 小时

**功能描述**:
优化各种加载状态，提供更好的用户体验。

**任务清单**:
- [ ] 添加骨架屏（Skeleton）组件
- [ ] 实现页面加载骨架
- [ ] 优化按钮加载状态
- [ ] 添加进度指示器

---

## 📦 Phase 4: 输入体验优化

### Task 4.1: @ 提及和 / 命令 ⭐⭐
**优先级**: 🟡 Medium  
**预计工时**: 4-5 小时

**功能描述**:
实现类似 Notion 的 @ 提及和 / 命令功能。

**任务清单**:
- [ ] 实现 @ 提及自动完成
  - [ ] 检测 @ 输入
  - [ ] 显示提及列表（用户、文档等）
  - [ ] 插入提及
- [ ] 实现 / 命令菜单
  - [ ] 检测 / 输入
  - [ ] 显示命令列表
  - [ ] 执行命令（如 /clear, /export 等）
- [ ] 创建命令注册系统

**验收标准**:
- [ ] @ 提及功能正常工作
- [ ] / 命令菜单正常显示
- [ ] 命令可以执行

---

### Task 4.2: 输入历史记录 ⭐
**优先级**: 🟢 Low  
**预计工时**: 1-2 小时

**功能清单**:
- [ ] 使用上下箭头浏览输入历史
- [ ] 历史记录存储在 localStorage
- [ ] 支持清除历史

---

## 📦 Phase 5: 数据导出和分享

### Task 5.1: 对话导出功能 ⭐
**优先级**: 🟡 Medium  
**预计工时**: 2-3 小时

**任务清单**:
- [ ] 实现 Markdown 导出
- [ ] 实现 PDF 导出（使用 jsPDF 或类似）
- [ ] 添加导出按钮到对话界面
- [ ] 实现导出历史记录

---

### Task 5.2: 对话分享功能 ⭐
**优先级**: 🟢 Low  
**预计工时**: 2-3 小时

**任务清单**:
- [ ] 实现分享链接生成
- [ ] 创建公开对话查看页面
- [ ] 添加分享权限控制
- [ ] 实现分享链接管理

---

## 📊 优先级排序

### 🔴 立即开始（本周）
1. Task 1.1: 对话历史持久化
2. Task 1.3: RAG 检索集成
3. Task 2.1: 用户设置页面
4. Task 3.1: 全局错误处理

### 🟡 近期完成（下周）
5. Task 1.2: 消息操作功能
6. Task 4.1: @ 提及和 / 命令
7. Task 5.1: 对话导出功能

### 🟢 后续优化
8. Task 2.2: 用户资料管理
9. Task 3.2: 加载状态优化
10. Task 4.2: 输入历史记录
11. Task 5.2: 对话分享功能

---

## 📝 开发规范

### 代码提交规范
- `feat:` 新功能
- `fix:` Bug 修复
- `enhance:` 功能增强
- `refactor:` 代码重构
- `docs:` 文档更新

### 分支命名
- `feature/task-1.1-conversation-persistence`
- `enhance/task-1.2-message-actions`
- `fix/bug-description`

### PR 要求
- 代码通过 lint 检查
- 添加必要的测试
- 更新相关文档
- 描述变更内容
